# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# CD â€” Deploy â†’ Healthcheck â†’ Rollback â†’ Notify
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# DÃ©clenchÃ© sur : tag semver (ex: v1.2.3)
#
# PrÃ©requis â€” GitHub Secrets Ã  configurer :
#   ANTHROPIC_API_KEY     â€” ClÃ© API Claude
#   LANGFUSE_PUBLIC_KEY   â€” ClÃ© publique LangFuse
#   LANGFUSE_SECRET_KEY   â€” ClÃ© secrÃ¨te LangFuse
#   VPS_HOST              â€” IP du serveur de production
#   VPS_USER              â€” Utilisateur SSH (ex: ubuntu)
#   VPS_SSH_KEY           â€” ClÃ© privÃ©e SSH (format PEM)
#
# PrÃ©requis â€” GitHub Variables (vars.*) :
#   VPS_DEPLOY_PATH       â€” RÃ©pertoire sur le VPS (ex: /opt/ai-agent-devops-demo)
#   SLACK_WEBHOOK_URL     â€” URL webhook Slack (optionnel)
#
# StratÃ©gie de rollback :
#   Le tag en cours d'exÃ©cution est sauvegardÃ© dans .current-tag sur le VPS
#   avant chaque dÃ©ploiement. En cas d'Ã©chec du healthcheck, le job rollback
#   redÃ©ploie automatiquement avec l'image prÃ©cÃ©dente.

name: CD

on:
  push:
    tags:
      - "v*.*.*"

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  # RÃ©pertoire de dÃ©ploiement sur le VPS
  DEPLOY_PATH: ${{ vars.VPS_DEPLOY_PATH || '/opt/ai-agent-devops-demo' }}

jobs:

  # â”€â”€ 1. Deploy â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: Deploy ${{ github.ref_name }} to production
    runs-on: ubuntu-latest
    environment: production  # Environnement GitHub avec protection rules optionnelles
    outputs:
      # Transmettre le rÃ©sultat au job rollback si nÃ©cessaire
      deployed-tag: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push versioned image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Deploy to VPS via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          # Le script s'exÃ©cute sur le VPS â€” chaque ligne est une commande shell
          script: |
            set -e

            # â”€â”€ Sauvegarde du tag courant pour rollback Ã©ventuel â”€â”€â”€â”€â”€â”€
            CURRENT_TAG_FILE="${{ env.DEPLOY_PATH }}/.current-tag"
            if [ -f "$CURRENT_TAG_FILE" ]; then
              cp "$CURRENT_TAG_FILE" "${{ env.DEPLOY_PATH }}/.previous-tag"
              echo "Previous tag: $(cat $CURRENT_TAG_FILE)"
            fi
            echo "${{ github.ref_name }}" > "$CURRENT_TAG_FILE"

            # â”€â”€ Mise Ã  jour du repo â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            cd ${{ env.DEPLOY_PATH }}
            git fetch origin --tags
            git checkout ${{ github.ref_name }}

            # â”€â”€ Pull de la nouvelle image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            echo "${{ secrets.GITHUB_TOKEN }}" | \
              docker login ghcr.io -u ${{ github.actor }} --password-stdin
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}

            # â”€â”€ RedÃ©marrage de l'agent uniquement â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            # Les services postgres et langfuse continuent de tourner
            IMAGE_TAG=${{ github.ref_name }} \
              docker compose -f docker-compose.yml -f docker-compose.prod.yml \
              up -d agent --no-deps

            echo "Deploy of ${{ github.ref_name }} completed"

  # â”€â”€ 2. Healthcheck â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Attend que /health rÃ©ponde 200 avant de valider le dÃ©ploiement.
  # 10 tentatives Ã— 5s = 50s max pour dÃ©marrer.
  healthcheck:
    name: Healthcheck (10 retries Ã— 5s)
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - name: Wait for /health to respond 200
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            PORT=3000
            MAX_RETRIES=10
            RETRY_DELAY=5

            echo "Waiting for agent to be healthy..."

            for i in $(seq 1 $MAX_RETRIES); do
              HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                --max-time 5 http://localhost:$PORT/health 2>/dev/null || echo "000")

              if [ "$HTTP_STATUS" = "200" ]; then
                echo "âœ… Health check passed on attempt $i (HTTP $HTTP_STATUS)"
                exit 0
              fi

              echo "Attempt $i/$MAX_RETRIES: HTTP $HTTP_STATUS â€” waiting ${RETRY_DELAY}s..."
              sleep $RETRY_DELAY
            done

            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            exit 1

  # â”€â”€ 3. Rollback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # DÃ©clenchÃ© uniquement si le healthcheck Ã©choue.
  # RedÃ©ploie automatiquement la version prÃ©cÃ©dente.
  rollback:
    name: Rollback to previous version
    runs-on: ubuntu-latest
    needs: healthcheck
    # S'exÃ©cute SEULEMENT si le healthcheck a Ã©chouÃ©
    if: failure()
    steps:
      - name: Rollback to previous image
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e
            PREVIOUS_TAG_FILE="${{ env.DEPLOY_PATH }}/.previous-tag"

            if [ ! -f "$PREVIOUS_TAG_FILE" ]; then
              echo "âŒ No previous tag found â€” cannot rollback automatically"
              exit 1
            fi

            PREVIOUS_TAG=$(cat "$PREVIOUS_TAG_FILE")
            echo "ğŸ”„ Rolling back to $PREVIOUS_TAG..."

            cd ${{ env.DEPLOY_PATH }}

            # RedÃ©marrer l'agent avec l'image prÃ©cÃ©dente
            IMAGE_TAG=$PREVIOUS_TAG \
              docker compose -f docker-compose.yml -f docker-compose.prod.yml \
              up -d agent --no-deps

            # Attendre que le rollback soit healthy
            for i in $(seq 1 10); do
              STATUS=$(curl -s -o /dev/null -w "%{http_code}" \
                --max-time 5 http://localhost:3000/health 2>/dev/null || echo "000")
              if [ "$STATUS" = "200" ]; then
                echo "âœ… Rollback to $PREVIOUS_TAG successful"
                # Remettre l'ancien tag comme courant
                echo "$PREVIOUS_TAG" > "${{ env.DEPLOY_PATH }}/.current-tag"
                exit 0
              fi
              echo "Rollback attempt $i: HTTP $STATUS"
              sleep 5
            done

            echo "âŒ Rollback also failed â€” manual intervention required"
            exit 1

  # â”€â”€ 4. Notify â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # Notification Slack/Discord aprÃ¨s chaque dÃ©ploiement (succÃ¨s ou Ã©chec).
  # Optionnel â€” activÃ© uniquement si SLACK_WEBHOOK_URL est configurÃ©.
  notify:
    name: Notify deployment result
    runs-on: ubuntu-latest
    needs: [deploy, healthcheck, rollback]
    # Toujours s'exÃ©cuter pour notifier mÃªme en cas d'Ã©chec
    if: always() && vars.SLACK_WEBHOOK_URL != ''
    steps:
      - name: Send Slack notification
        run: |
          # DÃ©terminer le statut global du pipeline
          HEALTHCHECK_RESULT="${{ needs.healthcheck.result }}"
          ROLLBACK_RESULT="${{ needs.rollback.result }}"

          if [ "$HEALTHCHECK_RESULT" = "success" ]; then
            EMOJI="âœ…"
            STATUS="Deployment successful"
            COLOR="#36a64f"
          elif [ "$ROLLBACK_RESULT" = "success" ]; then
            EMOJI="ğŸ”„"
            STATUS="Deployment failed â€” rolled back automatically"
            COLOR="#ff9500"
          else
            EMOJI="âŒ"
            STATUS="Deployment FAILED â€” manual intervention required"
            COLOR="#ff0000"
          fi

          curl -s -X POST "${{ vars.SLACK_WEBHOOK_URL }}" \
            -H "Content-Type: application/json" \
            -d "{
              \"attachments\": [{
                \"color\": \"$COLOR\",
                \"title\": \"$EMOJI ai-agent-devops-demo â€” $STATUS\",
                \"fields\": [
                  {\"title\": \"Version\", \"value\": \"${{ github.ref_name }}\", \"short\": true},
                  {\"title\": \"Deployed by\", \"value\": \"${{ github.actor }}\", \"short\": true},
                  {\"title\": \"Commit\", \"value\": \"${{ github.sha }}\", \"short\": false}
                ],
                \"footer\": \"GitHub Actions\",
                \"ts\": $(date +%s)
              }]
            }"

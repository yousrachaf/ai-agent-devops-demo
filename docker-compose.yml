# ════════════════════════════════════════════════════════════════
# docker-compose.yml — Stack de développement local complète
# ════════════════════════════════════════════════════════════════
#
# Services :
#   agent      — L'agent IA (port 3000)
#   langfuse   — Monitoring & observabilité (port 3001)
#   postgres   — Base de données LangFuse
#   clickhouse — Analytics LangFuse (profil "analytics" — opt-in)
#
# Démarrage rapide :
#   docker-compose up                        # Stack de base
#   docker-compose --profile analytics up   # + ClickHouse pour analytics v3
#
# ⚠️  Premier démarrage LangFuse :
#   1. Ouvrir http://localhost:3001
#   2. Créer un compte et un projet
#   3. Générer les clés API dans Settings → API Keys
#   4. Mettre à jour LANGFUSE_PUBLIC_KEY et LANGFUSE_SECRET_KEY dans .env
#   5. Relancer : docker-compose restart agent

name: ai-agent-devops-demo

services:

  # ── Agent IA ────────────────────────────────────────────────────
  agent:
    build:
      context: .
      dockerfile: Dockerfile
      target: production
    image: ai-agent-devops-demo:dev
    container_name: agent
    ports:
      - "3000:3000"
    # env_file charge .env ; les valeurs ci-dessous surchargent pour
    # pointer vers le LangFuse local plutôt que vers le cloud
    env_file:
      - .env
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
      # Pointer vers le LangFuse local (remplacer cloud.langfuse.com)
      LANGFUSE_HOST: http://langfuse:3000
    depends_on:
      langfuse:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "-qO-", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - agent-network

  # ── LangFuse — Observabilité IA ─────────────────────────────────
  # LangFuse trace chaque appel Claude (tokens, coût, latence, qualité)
  # Dashboard : http://localhost:3001
  langfuse:
    image: langfuse/langfuse:2
    container_name: langfuse
    ports:
      - "3001:3000"
    environment:
      # Connexion PostgreSQL
      DATABASE_URL: postgresql://langfuse:langfuse_dev_password@postgres:5432/langfuse

      # URL publique de LangFuse (utilisée pour les redirects OAuth et emails)
      NEXTAUTH_URL: http://localhost:3001

      # Secrets — CHANGER en production (openssl rand -base64 32)
      NEXTAUTH_SECRET: dev-nextauth-secret-change-in-production
      SALT: dev-salt-change-in-production

      # Désactiver la télémétrie vers les serveurs LangFuse en local
      TELEMETRY_ENABLED: "false"
    depends_on:
      postgres:
        condition: service_healthy
    healthcheck:
      # LangFuse expose une route de santé publique
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/api/public/health || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 60s  # Next.js met ~30-60s à démarrer
      retries: 5
    restart: unless-stopped
    networks:
      - agent-network

  # ── PostgreSQL — Base de données LangFuse ────────────────────────
  postgres:
    image: postgres:15-alpine
    container_name: postgres
    environment:
      POSTGRES_USER: langfuse
      POSTGRES_PASSWORD: langfuse_dev_password
      POSTGRES_DB: langfuse
      # Optimisation : réduire le logging pour le dev
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8"
    volumes:
      # Persistance des données entre les redémarrages
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U langfuse -d langfuse"]
      interval: 10s
      timeout: 5s
      start_period: 20s
      retries: 5
    restart: unless-stopped
    # PostgreSQL n'est pas exposé sur l'hôte — accessible uniquement aux services du réseau
    networks:
      - agent-network

  # ── ClickHouse — Analytics (opt-in) ─────────────────────────────
  # Requis pour LangFuse v3 et les analytics avancées.
  # Non démarré par défaut pour garder la stack légère en dev.
  #
  # Pour activer :
  #   docker-compose --profile analytics up
  # Et mettre à jour langfuse vers langfuse/langfuse:3
  clickhouse:
    image: clickhouse/clickhouse-server:24-alpine
    container_name: clickhouse
    profiles:
      - analytics
    environment:
      CLICKHOUSE_DB: langfuse
      CLICKHOUSE_USER: langfuse
      CLICKHOUSE_PASSWORD: langfuse_ch_dev_password
      CLICKHOUSE_DEFAULT_ACCESS_MANAGEMENT: "1"
    volumes:
      - clickhouse_data:/var/lib/clickhouse
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8123/ping || exit 1"]
      interval: 30s
      timeout: 10s
      start_period: 30s
      retries: 3
    restart: unless-stopped
    networks:
      - agent-network

# ── Volumes persistants ──────────────────────────────────────────
volumes:
  postgres_data:
    driver: local
  clickhouse_data:
    driver: local

# ── Réseau isolé ─────────────────────────────────────────────────
# Les services communiquent par nom (agent → langfuse, langfuse → postgres)
# sans exposer de ports inutiles sur l'hôte
networks:
  agent-network:
    driver: bridge
